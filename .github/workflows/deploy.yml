name: Deploy to GitHub Pages
on:
  # Runs on pushes targeting the main branch
  push:
    branches: ["main"]
  # Daily automatic rebuild at 00:00 UTC (midnight)
  schedule:
    - cron: "0 0 * * *"
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: 'npm'
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Install dependencies
        run: npm ci
        
      - name: Validate and Test TMDB API Key
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: |
          echo "üîç Checking TMDB API Key configuration..."
          
          # Check if the environment variable is set
          if [ -z "$TMDB_API_KEY" ]; then
            echo ""
            echo "‚ùå ERROR: TMDB_API_KEY is not configured!"
            echo ""
            echo "üìã To fix this, follow these steps:"
            echo "1. Get your TMDB API key:"
            echo "   ‚Üí Go to https://www.themoviedb.org/settings/api"
            echo "   ‚Üí If you don't have one, click 'Request an API Key'"
            echo "   ‚Üí Copy your API key (v3 auth)"
            echo ""
            echo "2. Add it to GitHub Secrets:"
            echo "   ‚Üí Go to your repository: Settings > Secrets and variables > Actions"
            echo "   ‚Üí Click 'New repository secret'"
            echo "   ‚Üí Name: TMDB_API_KEY"
            echo "   ‚Üí Value: [paste your API key]"
            echo "   ‚Üí Click 'Add secret'"
            echo ""
            exit 1
          fi
          
          echo "‚úÖ TMDB_API_KEY environment variable is set"
          echo "üîë Key length: ${#TMDB_API_KEY} characters"
          
          # Test the API key
          echo ""
          echo "üß™ Testing API key with TMDB..."
          response=$(curl -s -w "\n%{http_code}" "https://api.themoviedb.org/3/movie/popular?api_key=$TMDB_API_KEY")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "üì° HTTP Status Code: $http_code"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ TMDB API key is VALID and working!"
          elif [ "$http_code" -eq 401 ]; then
            echo ""
            echo "‚ùå ERROR: TMDB API returned 401 Unauthorized"
            echo ""
            echo "This means your API key is invalid or expired."
            echo ""
            echo "üîß To fix this:"
            echo "1. Verify your API key at: https://www.themoviedb.org/settings/api"
            echo "2. Make sure you're using the 'API Key (v3 auth)' not the 'API Read Access Token'"
            echo "3. Update the GitHub secret with the correct key"
            echo ""
            echo "Response: $body"
            exit 1
          else
            echo ""
            echo "‚ùå ERROR: TMDB API returned unexpected status: $http_code"
            echo "Response: $body"
            exit 1
          fi
        
      - name: Build with Astro
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
        run: npm run build
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

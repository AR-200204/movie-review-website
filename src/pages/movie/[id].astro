---
import { getPopularMovies, getMovieDetails } from '../../lib/tmdb.mjs';
import MovieDetail from '../../components/MovieDetail.astro';

export async function getStaticPaths() {
  try {
    const movies = await getPopularMovies(1);
    
    if (!movies || movies.length === 0) {
      throw new Error('No movies returned from TMDB API');
    }

    const paths = await Promise.all(movies.map(async (movie) => {
      try {
        const details = await getMovieDetails(movie.id);
        return {
          params: { id: movie.id.toString() },
          props: { movie: details }
        };
      } catch (error) {
        console.error(`Failed to fetch details for movie ${movie.id}:`, error);
        throw error;
      }
    }));
    
    return paths;
  } catch (error) {
    console.error('Fatal error in getStaticPaths:', error);
    // Re-throw to fail the build if API calls fail
    throw new Error(
      `Cannot generate movie pages: ${error.message}. ` +
      'Verify TMDB_API_KEY is valid and the API is accessible.'
    );
  }
}

const { movie } = Astro.props;
---

<MovieDetail movie={movie} />

